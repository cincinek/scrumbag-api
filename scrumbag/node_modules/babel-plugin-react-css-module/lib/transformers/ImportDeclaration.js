"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const core_1 = require("@babel/core");
const cache_1 = require("../cache");
function isStyleModule(node) {
    // TODO: 可配置
    return /\.(less|css|sass|scss)/.test(node.source.value);
}
function isSpecifiersImport(node) {
    return node.specifiers.length > 0;
}
exports.default = {
    ImportDeclaration(path, state) {
        const { node } = path;
        if (!isSpecifiersImport(node) && isStyleModule(node)) {
            const styles = path.scope.generateUidIdentifier('styles');
            cache_1.default.setStyles(styles.name);
            path.replaceWith(core_1.types.importDeclaration([core_1.types.importDefaultSpecifier(styles)], node.source));
        }
    },
    Program: {
        exit(path) {
            const firstNonImportDeclarationNode = path.get('body').find(node => {
                return !core_1.types.isImportDeclaration(node);
            });
            if (firstNonImportDeclarationNode && cache_1.default.getStyles().length > 0) {
                firstNonImportDeclarationNode.insertBefore(core_1.template.statements(`
            import ${cache_1.cssModuleFnName} from 'babel-plugin-react-css-module/lib/runtime';

            var ${cache_1.cssVar} = ${cache_1.cssModuleFnName}([${cache_1.default.getStyles()}]);
          `)());
            }
        },
    },
};
